"use client"

import React, { useEffect, useRef } from "react"
import type { JSX } from "react" // Import JSX for type definitions

// Emoji regex pattern extracted from @twemoji/parser
const emojiRegex =
  /(?:\ud83d\udc68\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc68\ud83c\udffc\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc68\ud83c\udffd\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc68\ud83c\udffe\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc68\ud83c\udfff\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffc\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffc\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffd\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffd\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffe\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffe\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udfff\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udfff\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83e\uddd1\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83e\uddd1\ud83c[\udffc-\udfff]|\ud83e\uddd1\ud83c\udffc\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83e\uddd1\ud83c[\udffb\udffd-\udfff]|\ud83e\uddd1\ud83c\udffd\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83e\uddd1\ud83c[\udffb-\udffc\udffe-\udfff]|\ud83e\uddd1\ud83c\udffe\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83e\uddd1\ud83c[\udffb-\udffd\udfff]|\ud83e\uddd1\ud83c\udfff\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83e\uddd1\ud83c[\udffb-\udffe]|\ud83d\udc68\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc68\ud83c\udffc\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc68\ud83c\udffd\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc68\ud83c\udffe\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc68\ud83c\udfff\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffc\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffc\u200d\u2764\ufe0f\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffd\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffd\u200d\u2764\ufe0f\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffe\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udffe\u200d\u2764\ufe0f\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udfff\u200d\u2764\ufe0f\u200d\ud83d\udc68\ud83c[\udffb-\udfff]|\ud83d\udc69\ud83c\udfff\u200d\u2764\ufe0f\u200d\ud83d\udc69\ud83c[\udffb-\udfff]|\ud83e\uddd1\ud83c\udffb\u200d\u2764\ufe0f\u200d\ud83e\uddd1\ud83c[\udffc-\udfff]|\ud83e\uddd1\ud83c\udffc\u200d\u2764\ufe0f\u200d\ud83e\uddd1\ud83c[\udffb\udffd-\udfff]|\ud83e\uddd1\ud83c\udffd\u200d\u2764\ufe0f\u200d\ud83e\uddd1\ud83c[\udffb-\udffc\udffe-\udfff]|\ud83e\uddd1\ud83c\udffe\u200d\u2764\ufe0f\u200d\ud83e\uddd1\ud83c[\udffb-\udffd\udfff]|\ud83e\uddd1\ud83c\udfff\u200d\u2764\ufe0f\u200d\ud83e\uddd1\ud83c[\udffb-\udffe]|\ud83d\udc68\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68|\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d[\udc68-\udc69]|\ud83e\uddd1\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83e\uddd1|\ud83d\udc68\u200d\u2764\ufe0f\u200d\ud83d\udc68|\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d[\udc68-\udc69]|\ud83e\uddd1\u200d\u2764\ufe0f\u200d\ud83e\uddd1|\ud83d\udc68\u200d\ud83d\udc68\u200d\ud83d\udc66\u200d\ud83d\udc66|\ud83d\udc68\u200d\ud83d\udc68\u200d\ud83d\udc67\u200d\ud83d[\udc66-\udc67]|\ud83d\udc68\u200d\ud83d\udc69\u200d\ud83d\udc66\u200d\ud83d\udc66|\ud83d\udc68\u200d\ud83d\udc69\u200d\ud83d\udc67\u200d\ud83d[\udc66-\udc67]|\ud83d\udc69\u200d\ud83d\udc69\u200d\ud83d\udc66\u200d\ud83d\udc66|\ud83d\udc69\u200d\ud83d\udc69\u200d\ud83d\udc67\u200d\ud83d[\udc66-\udc67]|\ud83d\udc68\u200d\ud83d\udc66\u200d\ud83d\udc66|\ud83d\udc68\u200d\ud83d\udc67\u200d\ud83d[\udc66-\udc67]|\ud83d\udc68\u200d\ud83d\udc68\u200d\ud83d[\udc66-\udc67]|\ud83d\udc68\u200d\ud83d\udc69\u200d\ud83d[\udc66-\udc67]|\ud83d\udc69\u200d\ud83d\udc66\u200d\ud83d\udc66|\ud83d\udc69\u200d\ud83d\udc67\u200d\ud83d[\udc66-\udc67]|\ud83d\udc69\u200d\ud83d\udc69\u200d\ud83d[\udc66-\udc67]|\ud83c\udff3\ufe0f\u200d\u26a7\ufe0f|\ud83c\udff3\ufe0f\u200d\ud83c\udf08|\ud83d\ude36\u200d\ud83c\udf2b\ufe0f|\u2764\ufe0f\u200d\ud83d\udd25|\u2764\ufe0f\u200d\ud83e\ude79|\ud83e\uddd1\u200d\ud83e\udd1d\u200d\ud83e\uddd1|\ud83d\udc68\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68|\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc68|\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83d\udc69|\ud83e\uddd1\u200d\u2764\ufe0f\u200d\ud83d\udc8b\u200d\ud83e\uddd1|\ud83d\udc68\u200d\u2764\ufe0f\u200d\ud83d\udc68|\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc68|\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc69|\ud83e\uddd1\u200d\u2764\ufe0f\u200d\ud83e\uddd1|\ud83d\udc68\u200d\u2764\ufe0f\u200d\ud83d\udc68|\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc68|\ud83d\udc69\u200d\u2764\ufe0f\u200d\ud83d\udc69|\ud83e\uddd1\u200d\u2764\ufe0f\u200d\ud83e\uddd1|\ud83d\udc68\u200d\ud83d\udc66|\ud83d\udc68\u200d\ud83d\udc67|\ud83d\udc68\u200d\ud83d\udc68\u200d\ud83d\udc66|\ud83d\udc68\u200d\ud83d\udc68\u200d\ud83d\udc67|\ud83d\udc68\u200d\ud83d\udc69\u200d\ud83d\udc66|\ud83d\udc68\u200d\ud83d\udc69\u200d\ud83d\udc67|\ud83d\udc69\u200d\ud83d\udc66|\ud83d\udc69\u200d\ud83d\udc67|\ud83d\udc69\u200d\ud83d\udc69\u200d\ud83d\udc66|\ud83d\udc69\u200d\ud83d\udc69\u200d\ud83d\udc67|\ud83c\udff4\u200d\u2620\ufe0f|\ud83d\udc41\u200d\ud83d\udde8|\ud83d\ude35\u200d\ud83d\udcab|\ud83d\ude2e\u200d\ud83d\udca8|\ud83e\udd3a|\ud83e\udd3b|\ud83e\udd3c|\ud83e\udd3d|\ud83e\udd3e|\ud83e\udd3f|\ud83e\udd40|\ud83e\udd41|\ud83e\udd42|\ud83e\udd43|\ud83e\udd44|\ud83e\udd45|\ud83e\udd46|\ud83e\udd47|\ud83e\udd48|\ud83e\udd49|\ud83e\udd4a|\ud83e\udd4b|\ud83e\udd4c|\ud83e\udd4d|\ud83e\udd4e|\ud83e\udd4f|\ud83e\udd50|\ud83e\udd51|\ud83e\udd52|\ud83e\udd53|\ud83e\udd54|\ud83e\udd55|\ud83e\udd56|\ud83e\udd57|\ud83e\udd58|\ud83e\udd59|\ud83e\udd5a|\ud83e\udd5b|\ud83e\udd5c|\ud83e\udd5d|\ud83e\udd5e|\ud83e\udd5f|\ud83e\udd60|\ud83e\udd61|\ud83e\udd62|\ud83e\udd63|\ud83e\udd64|\ud83e\udd65|\ud83e\udd66|\ud83e\udd67|\ud83e\udd68|\ud83e\udd69|\ud83e\udd6a|\ud83e\udd6b|\ud83e\udd6c|\ud83e\udd6d|\ud83e\udd6e|\ud83e\udd6f|\ud83e\udd70|\ud83e\udd71|\ud83e\udd72|\ud83e\udd73|\ud83e\udd74|\ud83e\udd75|\ud83e\udd76|\ud83e\udd77|\ud83e\udd78|\ud83e\udd79|\ud83e\udd7a|\ud83e\udd7b|\ud83e\udd7c|\ud83e\udd7d|\ud83e\udd7e|\ud83e\udd7f|\ud83e\udd80|\ud83e\udd81|\ud83e\udd82|\ud83e\udd83|\ud83e\udd84|\ud83e\udd85|\ud83e\udd86|\ud83e\udd87|\ud83e\udd88|\ud83e\udd89|\ud83e\udd8a|\ud83e\udd8b|\ud83e\udd8c|\ud83e\udd8d|\ud83e\udd8e|\ud83e\udd8f|\ud83e\udd90|\ud83e\udd91|\ud83e\udd92|\ud83e\udd93|\ud83e\udd94|\ud83e\udd95|\ud83e\udd96|\ud83e\udd97|\ud83e\udd98|\ud83e\udd99|\ud83e\udd9a|\ud83e\udd9b|\ud83e\udd9c|\ud83e\udd9d|\ud83e\udd9e|\ud83e\udd9f|\ud83e\udda0|\ud83e\udda1|\ud83e\udda2|\ud83e\udda3|\ud83e\udda4|\ud83e\udda5|\ud83e\udda6|\ud83e\udda7|\ud83e\udda8|\ud83e\udda9|\ud83e\uddaa|\ud83e\uddab|\ud83e\uddac|\ud83e\uddad|\ud83e\uddae|\ud83e\uddaf|\ud83e\uddb0|\ud83e\uddb1|\ud83e\uddb2|\ud83e\uddb3|\ud83e\uddb4|\ud83e\uddb5|\ud83e\uddb6|\ud83e\uddb7|\ud83e\uddb8|\ud83e\uddb9|\ud83e\uddba|\ud83e\uddbb|\ud83e\uddbc|\ud83e\uddbd|\ud83e\uddbe|\ud83e\uddbf|\ud83e\uddc0|\ud83e\uddc1|\ud83e\uddc2|\ud83e\uddc3|\ud83e\uddc4|\ud83e\uddc5|\ud83e\uddc6|\ud83e\uddc7|\ud83e\uddc8|\ud83e\uddc9|\ud83e\uddca|\ud83e\uddcb|\ud83e\uddcc|\ud83e\uddcd|\ud83e\uddce|\ud83e\uddcf|\ud83e\uddd0|\ud83e\uddd1|\ud83e\uddd2|\ud83e\uddd3|\ud83e\uddd4|\ud83e\uddd5|\ud83e\uddd6|\ud83e\uddd7|\ud83e\uddd8|\ud83e\uddd9|\ud83e\uddda|\ud83e\udddb|\ud83e\udddc|\ud83e\udddd|\ud83e\uddde|\ud83e\udddf|\ud83e\udde0|\ud83e\udde1|\ud83e\udde2|\ud83e\udde3|\ud83e\udde4|\ud83e\udde5|\ud83e\udde6|\ud83e\udde7|\ud83e\udde8|\ud83e\udde9|\ud83e\uddea|\ud83e\uddeb|\ud83e\uddec|\ud83e\udded|\ud83e\uddee|\ud83e\uddef|\ud83e\uddf0|\ud83e\uddf1|\ud83e\uddf2|\ud83e\uddf3|\ud83e\uddf4|\ud83e\uddf5|\ud83e\uddf6|\ud83e\uddf7|\ud83e\uddf8|\ud83e\uddf9|\ud83e\uddfa|\ud83e\uddfb|\ud83e\uddfc|\ud83e\uddfd|\ud83e\uddfe|\ud83e\uddff|\ud83d[\udc00-\ude4f]|\ud83c[\udf00-\udfff]|\ud83e[\udd00-\uddff]|[\u2600-\u27bf]|[\u2300-\u23ff]|[\u2b50]|[\u2934-\u2935]|[\u2b05-\u2b07]|[\u3030]|[\u303d]|[\u3297]|[\u3299]|[\u00a9]|[\u00ae]|[\u2122]|[\u23e9-\u23ef]|[\u23f8-\u23fa]|[\u25aa-\u25ab]|[\u25b6]|[\u25c0]|[\u25fb-\u25fe]|[\u2600-\u2604]|[\u260e]|[\u2611]|[\u2614-\u2615]|[\u2618]|[\u261d]|[\u2620]|[\u2622-\u2623]|[\u2626]|[\u262a]|[\u262e-\u262f]|[\u2638-\u263a]|[\u2640]|[\u2642]|[\u2648-\u2653]|[\u265f-\u2660]|[\u2663]|[\u2665-\u2666]|[\u2668]|[\u267b]|[\u267e-\u267f]|[\u2692-\u2697]|[\u2699]|[\u269b-\u269c]|[\u26a0-\u26a1]|[\u26a7]|[\u26aa-\u26ab]|[\u26b0-\u26b1]|[\u26bd-\u26be]|[\u26c4-\u26c5]|[\u26c8]|[\u26ce-\u26cf]|[\u26d1]|[\u26d3-\u26d4]|[\u26e9-\u26ea]|[\u26f0-\u26f5]|[\u26f7-\u26fa]|[\u26fd]|[\u2702]|[\u2705]|[\u2708-\u270d]|[\u270f]|[\u2712]|[\u2714]|[\u2716]|[\u271d]|[\u2721]|[\u2728]|[\u2733-\u2734]|[\u2744]|[\u2747]|[\u274c]|[\u274e]|[\u2753-\u2755]|[\u2757]|[\u2763-\u2764]|[\u2795-\u2797]|[\u27a1]|[\u27b0]|[\u27bf]|[\u2934-\u2935]|[\u2b05-\u2b07]|[\u2b1b-\u2b1c]|[\u2b50]|[\u2b55]|[\u231a-\u231b]|[\u23e9-\u23ec]|[\u23f0]|[\u23f3])/g

// Convert emoji to codepoint (hex string)
function toCodePoint(emoji: string): string {
  const codePoints: string[] = []
  let i = 0

  while (i < emoji.length) {
    const code = emoji.charCodeAt(i)

    // Check for surrogate pairs (high surrogate)
    if (code >= 0xd800 && code <= 0xdbff && i + 1 < emoji.length) {
      const high = code
      const low = emoji.charCodeAt(i + 1)

      if (low >= 0xdc00 && low <= 0xdfff) {
        // Combine surrogate pair into single codepoint
        const codePoint = 0x10000 + ((high - 0xd800) << 10) + (low - 0xdc00)
        codePoints.push(codePoint.toString(16))
        i += 2
        continue
      }
    }

    codePoints.push(code.toString(16))
    i++
  }

  return codePoints.join("-")
}

// Parse text and replace emojis with img tags
function parseEmoji(text: string, baseUrl: string, className: string): string {
  return text.replace(emojiRegex, (match) => {
    // Remove variation selector (U+FE0F) if not followed by zero-width joiner
    const cleanEmoji = match.indexOf("\u200D") < 0 ? match.replace(/\uFE0F/g, "") : match

    const codePoint = toCodePoint(cleanEmoji)
    const src = `${baseUrl}${codePoint}.svg`

    return `<img class="${className}" draggable="false" alt="${match}" src="${src}" />`
  })
}

// Removes emojis from text that are not matched by emojiRegex (i.e., unsupported emojis)
function cleanUnsupportedEmojis(text: string): string {
  // Allow only emojis matched by emojiRegex, remove the rest of emojis
  // This will remove any emoji not covered by emojiRegex, but keep all non-emoji text as is
  // Step 1: Find all emoji code points in the text
  // Step 2: For each emoji, if not matched by emojiRegex, remove it

  // First, match all emojis in the text using a generic emoji unicode range regex
  // Reference: https://stackoverflow.com/questions/10992921/how-to-remove-emojis-from-string
  const allEmojiRegex = /([\u203C-\u3299]|\uD83C[\uDC00-\uDFFF]|\uD83D[\uDC00-\uDE4F]|\uD83D[\uDE80-\uDEFF]|\uD83E[\uDD00-\uDFFF])/g;

  // Replace all emojis not matching emojiRegex
  return text.replace(allEmojiRegex, (match) => {
    if (emojiRegex.test(match)) {
      return match; // Supported, keep it
    }
    return ""; // Remove unsupported emoji
  });
}

interface TwemojiProps {
  children: React.ReactNode
  className?: string
  baseUrl?: string
  emojiClassName?: string
  tag?: keyof JSX.IntrinsicElements
}

export function Twemoji({
  children,
  className = "",
  baseUrl = "https://platform.uhuu.io/common/vendors/twemoji/assets/svg/",
  emojiClassName = "inline-block w-[1.2em] h-[1.2em] align-text-top",
  tag: Tag = "div",
}: TwemojiProps) {
  const containerRef = useRef<HTMLElement>(null)

  useEffect(() => {
    if (!containerRef.current) return

    // Find all text nodes and parse emojis
    const parseTextNodes = (node: Node) => {
      if (node.nodeType === Node.TEXT_NODE) {
        const text = node.textContent || ""
        if (emojiRegex.test(text)) {
          const parsed = parseEmoji(text, baseUrl, emojiClassName)
          const temp = document.createElement("span")
          temp.innerHTML = cleanUnsupportedEmojis(parsed)
          // Replace text node with parsed content
          const parent = node.parentNode
          if (parent) {
            while (temp.firstChild) {
              parent.insertBefore(temp.firstChild, node)
            }
            parent.removeChild(node)
          }
        }
      } else if (node.nodeType === Node.ELEMENT_NODE) {
        const element = node as HTMLElement
        // Skip script, style, and other non-parseable elements
        if (!["SCRIPT", "STYLE", "TEXTAREA", "SELECT", "IFRAME"].includes(element.tagName)) {
          Array.from(node.childNodes).forEach(parseTextNodes)
        }
      }
    }

    

    parseTextNodes(containerRef.current)
  }, [children, baseUrl, emojiClassName])

  return React.createElement(Tag, { ref: containerRef, className }, children)
}
